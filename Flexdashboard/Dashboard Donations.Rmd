---
title: "Donations Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: columns
    vertical_layout: fill
runtime: shiny
runApp: showcase
---


```{r global, include = FALSE}


library(tidyverse)
library(readxl)
# library(ggthemes)
# library(astsa)
# library(forecast)
# library(xts)
# library(aspace)
# library(forecast)
# library(data.table)
# library(leaflet)
library(plotly)

########################  Import data ########################

# Donations dataset

### Group codes
## Import table with group codes
table_group_codes <-
  read_excel(
    "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/nominal ledgers and source groups.xlsx"
  ) %>%
  select(-Recnum) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .)))



### Source codes, group codes
## Import table with sources codes and join with group codes
table_source_codes <-
  read_excel(
    "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/all source codes.xlsx",
    skip = 1
  ) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .))) %>%
  select(-c(not.in.use)) %>%
  mutate(source.group = substr(source, 1, 3)) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .))) %>%
  left_join(table_group_codes, by = "source.group") %>%
  mutate_if(is.character, funs(as.factor))

### Source codes, group codes, nominal descriptions
## Import table with nominal descriptions and join with source/group codes
table_nominal_descriptions <-
  read_excel(
    "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/nominal descriptions.xlsx"
  ) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  mutate_all(funs(as.factor)) %>%
  left_join(table_source_codes, by = c("nominal.codes" = "nominal.ledger"))

### Income stream codes
## Import Income Stream table
table_income_stream <-
  read_excel(
    "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/income stream.xlsx",
    skip = 1
  ) %>%
  rename_all(funs(tolower(make.names(.))))

### Regular donors details
## Import Regular Givers details
table_RG_details <-
  read_excel(
    "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/Regular givers detail.xlsx"
  ) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  select(-c(start.date, terminated.on)) %>%
  mutate_at(vars(frequency), funs(as.factor))

### Donations
## Import main donations dataset
dataset_donations <-
      read_excel(
      "~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/Donations_6Years (nopass).xlsx",
      sheet = "Fernando_6year_3.7.18_1"
    ) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  select(-c(address1)) %>%
  ### Source codes, group codes, income stream, regular givers details, main dataset
  ## Join main donation dataset with Income Stream and RG
  inner_join(table_income_stream, by = "journal.no") %>%
  left_join(table_RG_details, by = c("donor.no", c("donation.amount" = "instalment.amount"))) %>%
  ### Source codes, group codes, nominal descriptions, income stream, regular givers details, main dataset
  ## Join main donations dataset with Income stream and RG with source codes, group codes, nominal descriptions
  mutate(day = strftime(.$donation.date, format = "%d")) %>%
  mutate(week = strftime(.$donation.date, format = "%V")) %>%
  mutate(month = strftime(.$donation.date, format = "%m")) %>%
  mutate(year = strftime(.$donation.date, format = "%Y")) %>%
  mutate(source.group = substr(source, 1, 3)) %>%
  left_join(table_nominal_descriptions, by = "source") %>%
  distinct(journal.no, .keep_all = TRUE) %>%
  mutate_if(is.character, funs(as.factor)) %>%
  mutate_at(vars(donor.no, nominal), funs(as.factor)) %>%
  select(
    -source.group.x,
    source.group = source.group.y,
    donor.postcode = postcode,
    donor.town = town,
    donor.gender = gender,
    donation.day = day,
    donation.week = week,
    donation.month = month,
    donation.year = year,
    everything()
  )

```



Donations {data-width=700}
====================

Sidebar {.sidebar}
-----------------

<br>

```{r}


## Select input to select graph
selectInput(
  inputId = "graphid",
  label = "Select the Graph to Display",
  choices =  c(
    "Sum of Donations" = "sum.donations",
    "Average of Donations" = "average.donations",
    "Number of Donations" = "number.donations"
  ),
  multiple = FALSE
)

# Date input
dateRangeInput(
  inputId = "dateid1",
  label = "Select dates",
  start = "2017-04-01",
  end = Sys.Date(),
  min = "2015-01-01",
  max = Sys.Date(),
  startview = "year"
)


# Selection input of nominal code
selectInput(
  inputId = "nominalid",
  label = "Select the Nominal Code",
  choices = c("", levels(dataset_donations$nominal)),
  multiple = FALSE
)

# Selection input of source group code
selectInput(
  inputId = "sourcegroupid",
  label = "Select the Source Group Code",
  choices = NULL,
  multiple = FALSE
)

# Selection input of source code
selectInput(
  inputId = "sourceid",
  label = "Select the Source Code",
  choices = NULL,
  multiple = FALSE
)

radioButtons(
  inputId = "levelsid",
  label = "Select the Level of Detail of the Graph",
  choices = c("By Nominal" = "nominal", "By Source Group" = "source.group", "By Source Code" = "source")
)

## Boton to create plot
actionButton(inputId = "actionid1",
             label = "Clic to Generate Graph")

## Code for making the source.group and source input depend on the nominal code
observeEvent(input$nominalid, {
  filtered_donations1 <- dataset_donations %>%
    filter(nominal == input$nominalid, in.use == "Y") %>%
    distinct(source.group)
  
  updateSelectInput(session, "sourcegroupid", choices = c(filtered_donations1))
  
})

observeEvent(input$sourcegroupid, {
  filtered_donations2 <- dataset_donations %>%
    filter(source.group == input$sourcegroupid, in.use == "Y") %>%
    distinct(source)
  
  updateSelectInput(session, "sourceid", choices = c(filtered_donations2))
  
})

dataset_donations_base<- dataset_donations %>%
  select(
  donor.no,
  journal.no,
  donation.date,
  nominal,
  source.group,
  source,
  donation.day,
  donation.week,
  donation.month,
  donation.year,
  donation.amount
  ) %>%
  mutate(year.unite = strftime(.$donation.date, format = "%Y")) %>%
  mutate(month.unite = strftime(.$donation.date, format = "%m")) %>%
  unite(MY, month.unite, year.unite) 

## Create reactive objects that will depend on date, nominal, source.group and source code

reactiveDonations <- reactive({

 data<- dataset_donations_base %>% 
  group_by_at(vars(MY, input$levelsid)) %>%
    mutate(
    sum.donations = sum(donation.amount),
    average.donations = mean(donation.amount),
    number.donations = n()
    ) %>%
    ungroup() %>%
    gather(index, value, -c(donor.no:donation.year, MY))
    
})

  reactiveDonationsFiltered<- reactive({
  if (input$levelsid == "nominal") {
  reactiveDonations() %>%
      filter(
      donation.date >= input$dateid1[1] &
      donation.date <= input$dateid1[2],
      index == input$graphid,
      nominal == input$nominalid
      )


  } else if (input$levelsid == "source.group") {
   reactiveDonations() %>%
      filter(
      donation.date >= input$dateid1[1] &
      donation.date <= input$dateid1[2],
      nominal == input$nominalid,
      source.group == input$sourcegroupid,
      index == input$graphid
      )


  } else if (input$levelsid == "source") {
 reactiveDonations() %>%
      filter(
      donation.date >= input$dateid1[1] &
      donation.date <= input$dateid1[2],
      nominal == input$nominalid,
      source.group == input$sourcegroupid,
      source == input$sourceid,
      index == input$graphid
      )
  }
  
})


```

column {data-width=700}
----------------------

### Plot

```{r}

renderPlotly({
  req(input$actionid1)
  ggplotly((reactiveDonationsFiltered()) %>%
  ggplot(
  aes(donation.month,
  value,
  group = donation.year,
  colour = donation.year)
  ) +
  geom_line())
})
```



<!-- Donors {data-width=700} -->
<!-- ==================== -->

<!-- Sidebar {.sidebar} -->
<!-- ----------------- -->

<!-- <br> -->

<!-- ```{r} -->


<!-- ## Select input to select graph -->
<!-- selectInput( -->
<!--   inputId = "graphid2", -->
<!--   label = "Select the Graph to Display", -->
<!--   choices =  c("Total Donors" = "donors.per.month", "New Donors" = "sum.new.donors"), -->
<!--   multiple = FALSE -->
<!-- ) -->

<!-- # Date input -->
<!-- dateRangeInput( -->
<!--   inputId = "dateid2", -->
<!--   label = "Select dates", -->
<!--   start = "2017-04-01", -->
<!--   end = Sys.Date(), -->
<!--   min = "2015-01-01", -->
<!--   max = Sys.Date(), -->
<!--   startview = "year" -->
<!--   ) -->

<!-- # Selection input of nominal code -->
<!-- selectInput( -->
<!--   inputId = "nominalid2", -->
<!--   label = "Select the Nominal Code", -->
<!--   choices = c("", levels(dataset_donations$nominal)), -->
<!--   multiple = FALSE -->
<!--   ) -->

<!-- # Selection input of source group code -->
<!-- selectInput( -->
<!--   inputId = "sourcegroupid2", -->
<!--   label = "Select the Source Group Code", -->
<!--   choices = NULL, -->
<!--   multiple = FALSE -->
<!--   ) -->

<!-- # Selection input of source code -->
<!-- selectInput( -->
<!--   inputId = "sourceid2", -->
<!--   label = "Select the Source Code", -->
<!--   choices = NULL, -->
<!--   multiple = FALSE -->
<!--   ) -->

<!-- radioButtons( -->
<!--   inputId = "levelsid2", -->
<!--   label = "Select the Level of Detail of the Graph", -->
<!--   choices = c("By Nominal", "By Source Group", "By Source Code") -->
<!--   ) -->

<!-- ## Boton to create plot -->
<!-- actionButton(inputId = "actionid2", -->
<!--              label = "Clic to Generate Graph") -->


<!-- ## Code for making the source.group and source input depend on the nominal code -->
<!-- observeEvent(input$nominalid2, { -->
<!--   filtered_donations2 <- dataset_donations %>% -->
<!--   filter(nominal == input$nominalid2, in.use == "Y") %>% -->
<!--   distinct(source.group) -->

<!--   updateSelectInput(session, "sourcegroupid2", choices = c(filtered_donations2)) -->

<!-- }) -->

<!-- observeEvent(input$sourcegroupid2, { -->
<!--   filtered_donations2 <- dataset_donations %>% -->
<!--   filter(source.group == input$sourcegroupid2, in.use == "Y") %>% -->
<!--   distinct(source) -->

<!--   updateSelectInput(session, "sourceid2", choices = c(filtered_donations2)) -->

<!-- }) -->


<!-- dataset_donors_base <- dataset_donations %>% -->
<!--   select( -->
<!--   journal.no, -->
<!--   donation.date, -->
<!--   nominal, -->
<!--   source.group, -->
<!--   source, -->
<!--   donation.day, -->
<!--   donation.week, -->
<!--   donation.month, -->
<!--   donation.year, -->
<!--   donor.no -->
<!--   ) %>% -->
<!--   mutate(year.unite = strftime(.$donation.date, format = "%Y")) %>% -->
<!--   mutate(month.unite = strftime(.$donation.date, format = "%m")) %>% -->
<!--   unite(MY, month.unite, year.unite)  -->

<!-- ## Create reactive dataset that will depend on date, nominal, source.group and source code -->

<!-- reactiveDonorsNominal <- reactive({ -->
<!--  dataDon<- dataset_donors_base %>%  -->
<!--      group_by(nominal, donor.no) -->

<!--  if (input$graphid2 == "New Donors"){ -->

<!--   DataDon2<- dataDon %>% mutate(donations.per.donor = n()) %>% -->
<!--   ungroup() %>% -->
<!--   # gather(index, value, -c(journal.no:donation.year, MY)) %>% -->
<!--   filter(donations.per.donor == 1) %>% -->
<!--   group_by(MY, nominal) %>% -->
<!--   mutate(sum.new.donors = n()) %>% -->
<!--   ungroup()  -->

<!--   return(DataDon2) -->

<!--  } else if (input$graphid2 == "Total Donors"){ -->
<!--   distinct(donor.no, .keep_all = TRUE) %>% -->
<!--   mutate(donors.per.month = n()) %>% -->
<!--   ungroup()  -->

<!--   return(DataDon2) -->

<!--  } -->
<!-- }) -->

<!-- # reactiveDonorsSourceGroup <- reactive({ -->
<!-- #  -->
<!-- # }) -->
<!-- # reactiveDonorsSource <- reactive({ -->
<!-- #  -->
<!-- # }) -->

<!-- ``` -->

<!-- column {data-width=700} -->
<!-- ---------------------- -->

<!-- ### Plot -->

<!-- ```{r} -->
<!-- renderPlotly({ -->
<!--   req(input$actionid2) -->
<!--    ggplotly(isolate(reactiveDonorsNominal()) %>% -->
<!--   ggplot(aes( -->
<!--     donation.month, -->
<!--     sum.new.donors, -->
<!--     group = donation.year, -->
<!--     colour = donation.year -->
<!--   )) + # In shiny gere goes input$sum, mean... -->
<!--   geom_line()) -->

<!--   }) -->

<!-- ``` -->






