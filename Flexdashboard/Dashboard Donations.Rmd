---
title: "Donations Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: columns
    vertical_layout: fill
runtime: shiny
runApp: showcase
---


```{r global, include=FALSE}


library(tidyverse)
library(readxl)
library(ggthemes)
library(astsa)
library(forecast)
library(xts) 
library(aspace)
library(forecast)
library(data.table)
library(leaflet)
library(plotly)

########################  Import data ########################  

# Donations dataset

### Group codes
## Import table with group codes
table_group_codes<- read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/nominal ledgers and source groups.xlsx") %>%
  select(-Recnum) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .)))

### Source codes, group codes
## Import table with sources codes and join with group codes
table_source_codes<- read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/all source codes.xlsx",
                                skip = 1) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .))) %>%
  select(-c(not.in.use)) %>%
  mutate(source.group = substr(source, 1, 3)) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  rename_all(funs(gsub("_", ".", .))) %>%
  left_join(table_group_codes, by = "source.group") %>%
  mutate_if(is.character, funs(as.factor))

### Source codes, group codes, nominal descriptions
## Import table with nominal descriptions and join with source/group codes
table_nominal_descriptions <- read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/nominal descriptions.xlsx") %>%
  rename_all(funs(tolower(make.names(.)))) %>% 
  mutate_all(funs(as.factor)) %>%
  left_join(table_source_codes, by = c("nominal.codes" = "nominal.ledger")) 

### Income stream codes
## Import Income Stream table
table_income_stream <- read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/income stream.xlsx", 
                                  skip = 1) %>%
  rename_all(funs(tolower(make.names(.))))

### Regular donors details
## Import Regular Givers details
table_RG_details<- read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/Regular givers detail.xlsx") %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  select(-c(start.date, terminated.on)) %>%
  mutate_at(vars(frequency), funs(as.factor)) 

### Donations
## Import main donations dataset
dataset_donations <- as.tibble(read_excel("~/Google Drive/Data Analysis/Bases de Datos/St. Cuthberts/Support Services/Donations_6Years (nopass).xlsx",
                                          sheet = "Fernando_6year_3.7.18_1")) %>%
  rename_all(funs(tolower(make.names(.)))) %>%
  select(-c(address1)) %>%
  ### Source codes, group codes, income stream, regular givers details, main dataset
  ## Join main donation dataset with Income Stream and RG
  inner_join(table_income_stream, by ="journal.no") %>%
  left_join(table_RG_details, by = c("donor.no", c("donation.amount" = "instalment.amount"))) %>%
  ### Source codes, group codes, nominal descriptions, income stream, regular givers details, main dataset
  ## Join main donations dataset with Income stream and RG with source codes, group codes, nominal descriptions 
  mutate(day = strftime(.$donation.date, format = "%d")) %>%
  mutate(week = strftime(.$donation.date, format = "%V")) %>%
  mutate(month = strftime(.$donation.date, format = "%m")) %>%
  mutate(year = strftime(.$donation.date, format = "%Y")) %>%
  mutate(source.group = substr(source, 1, 3)) %>%
  left_join(table_nominal_descriptions, by = "source") %>%
  distinct(journal.no, .keep_all = TRUE) %>%
  mutate_if(is.character, funs(as.factor)) %>%
  mutate_at(vars(donor.no, nominal), funs(as.factor)) %>%
  select(-source.group.x,
         source.group = source.group.y,
         donor.postcode = postcode, 
         donor.town = town, 
         donor.gender = gender, 
         donation.day = day,
         donation.week = week,
         donation.month = month, 
         donation.year = year,
         everything()) 

```


Donations
====================

Column {.sidebar data-width=300}
-----------------------------------------------------------------------
<br>
```{r}

## Select input to select graph
selectInput(inputId = "graphid",
                      label = "Select the Graph to Display",
                      choices =  c("Sum of Donations" = "sum.donations", "Average of Donations" = "average.donations", "Number of Donations" = "number.donations"),
                      multiple = FALSE)

# Date input
dateRangeInput(inputId = "dateid1",
                       label = "Select dates",
                       start = "2017-04-01", 
                       end = Sys.Date(),
                       min = "2015-01-01", 
                       max = Sys.Date(),
                       startview = "year")

# Selection input of nominal code
selectInput(inputId = "nominalid",
                      label = "Select the Nominal Code",
                      choices = c("", levels(dataset_donations$nominal)),
                      multiple = FALSE)

# Selection input of source group code
selectInput(inputId = "source.groupid",
                      label = "Select the Source Group Code",
                      choices = NULL,
                      multiple = FALSE)

# Selection input of source code
selectInput(inputId = "sourceid",
                      label = "Select the Source Code",
                      choices = NULL,
                      multiple = FALSE)


## Boton to create plot
actionButton(inputId = "actionid1", 
             label = "Clic to Generate Graph")

## Code for making the source.group and source input depend on the nominal code
observeEvent(input$nominalid, {
   filtered_donations1 <- dataset_donations %>%
     filter(nominal == input$nominalid, in.use == "Y") %>%
              distinct(source.group)
   
  updateSelectInput(session, "source.groupid", choices = filtered_donations1)
   
})

observeEvent(input$source.groupid, {
  filtered_donations2 <- dataset_donations %>%
    filter(source.group == input$source.groupid, in.use == "Y") %>%
    distinct(source)
  
  updateSelectInput(session, "sourceid", choices = filtered_donations2)
  
})


## Create reactive dataset that will depend on date, nominal, source.group and source code
reactiveDonations<- reactive({
  if (input$nominalid == "") {

    dataset_donations %>%
    select(journal.no, 
         donation.date, 
         nominal, 
         source.group,
         source,
         donation.day,
         donation.week,
         donation.month,
         donation.year,
         donation.amount) %>%
  mutate(year.unite = strftime(.$donation.date, format = "%Y")) %>%
  mutate(month.unite = strftime(.$donation.date, format = "%m")) %>%
  unite(MY, month.unite, year.unite) %>%
  group_by(MY) %>%
  mutate(sum.donations = sum(donation.amount), 
         average.donations = mean(donation.amount),
         number.donations = n()) %>%
  ungroup() %>%
  gather(index, value, -c(journal.no:donation.year, MY)) %>% 
               filter(donation.date >= input$dateid1[1] & donation.date <= input$dateid1[2], index == input$graphid)

} else {
  
  dataset_donations %>%
    select(journal.no, 
         donation.date, 
         nominal, 
         source.group,
         source,
         donation.day,
         donation.week,
         donation.month,
         donation.year,
         donation.amount) %>%
  mutate(year.unite = strftime(.$donation.date, format = "%Y")) %>%
  mutate(month.unite = strftime(.$donation.date, format = "%m")) %>%
  unite(MY, month.unite, year.unite) %>%
  group_by(MY, source) %>% 
  mutate(sum.donations = sum(donation.amount), 
         average.donations = mean(donation.amount),
         number.donations = n()) %>%
  ungroup() %>%
  gather(index, value, -c(journal.no:donation.year, MY)) %>% 
               filter(donation.date >= input$dateid1[1] & donation.date <= input$dateid1[2],
                      nominal == input$nominalid,
                      source.group == input$source.groupid,
                      source == input$sourceid,
                      index == input$graphid)
  
}
})
  
  

```

<style>
body {
text-align: left}
</style>

<br>

**IPOS Score by Group**

The IPOS Scores are formed with 10 questions, each one with a maximum score of 4; a high value indicates an area to improve.

The questions have been grouped into three categories:

* Psychological IPOS (Q3, Q5, Q6)
<br>

* External IPOS (Q4, Q7, Q8, Q9)
<br>

* Medical IPOS (Q2)

By exploring different age ranges and their average IPOS Scores, grouped by category, it is possible to identify which age range needs support in which area, as well as detect trends for improvement.

<br>



Column {data-width=700}
-----------------------------------------------------------------------

### Donations Across Time

```{r}
renderPlotly({
  req(input$actionid1)
  ggplotly(isolate(reactiveDonations()) %>%
  # select(journal.no, 
  #        donation.date, 
  #        nominal, 
  #        source.group,
  #        source,
  #        donation.day,
  #        donation.week,
  #        donation.month,
  #        donation.year,
  #        donation.amount) %>%
  # mutate(year.unite = strftime(.$donation.date, format = "%Y")) %>%
  # mutate(month.unite = strftime(.$donation.date, format = "%m")) %>%
  # unite(MY, month.unite, year.unite) %>%
  # group_by(MY, source) %>% # In shiny gere goes input$Nominal, source...
  # mutate(sum.donations = sum(donation.amount), 
  #        average.donations = mean(donation.amount),
  #        number.donations = n()) %>%
  # ungroup() %>%
  # gather(index, value, -c(journal.no:donation.year, MY)) %>%
  ggplot(aes(donation.month, value, group = donation.year, colour = donation.year)) + # In shiny gere goes input$sum, mean...
  geom_line()
  )
})
```


<!-- Patient's Dashboard -->
<!-- ==================== -->

<!-- Column {.sidebar data-width=300} -->
<!-- ----------------------------------------------------------------------- -->
<!-- <br> -->
<!-- ```{r} -->

<!-- selectInput(inputId = "userid", -->
<!--           label = "Write the NHS Number of Patient", -->
<!--           choices = c("", unique(dataset_viz_ipu_oacc$anonymous.patient.id)), -->
<!--           selected = "", -->
<!--           multiple = FALSE) -->

<!-- checkboxGroupInput(inputId = "measurementid", -->
<!--                       label = "Select the Measurement Tool to Display", -->
<!--                       choices =  levels(dataset_viz_ipu_oacc$measurement)) -->


<!-- selectInput(inputId = "indexid", -->
<!--                       label = "Select an Index", -->
<!--                       choices = NULL, -->
<!--                       multiple = FALSE) -->

<!-- actionButton(inputId = "actionid", -->
<!--              label = "Clic to Generate Graph") -->

<!-- observeEvent(input$measurementid, { -->
<!--    filtered <- dataset_viz_ipu_oacc %>% -->
<!--      filter(measurement == input$measurementid) %>% -->
<!--               distinct(index) -->

<!--    updateSelectInput(session, "indexid", choices = filtered) -->
<!-- }) -->


<!-- reactiveOacc3<- reactive({ -->
<!--   dataset_viz_ipu_oacc %>% -->
<!--     select(Spell = spell, Score = values, Date.of.Contact = date.of.contact, everything()) %>% -->
<!--                filter(anonymous.patient.id == input$userid, -->
<!--                       measurement == input$measurementid, -->
<!--                       index == input$indexid) -->

<!-- }) -->

<!-- reactiveOacc4<- reactive({ -->
<!--   dataset_viz_ipu_oacc %>% -->
<!--     select(Spell = spell, Score = values, Date.of.Contact = date.of.contact, everything()) %>% -->
<!--                filter(anonymous.patient.id == input$userid, measurement == "Australian Karnofsky Performance Status") -->

<!-- }) -->


<!-- ``` -->

<!-- <style> -->
<!-- body { -->
<!-- text-align: left} -->
<!-- </style> -->

<!-- <br> -->

<!-- The selector allows the user to specify a particular patient, an Outcome Meassure and the Index related to it. -->

<!-- The first chart will show the selected Index and its linear tendency line, while the second graph will show the AKPS Score. The numbers following the line represent the spell's number, which when taking into account the time it indicates the lenght of each spell. -->

<!-- By exploring different indexes it is possible to understand which ones increase or decrease at the moment the patient's disease evolves, as well as see trends and take actions for improvement. -->

<!-- <br> -->


<!-- Column {data-width=700 {.tabset}} -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Outcome Meassurement -->

<!-- ```{r} -->

<!-- renderPlotly({ -->
<!--   req(input$actionid) -->
<!--   ggplotly(isolate(reactiveOacc3()) %>% -->
<!--   ggplot(aes(Date.of.Contact, Score, label = Spell)) + -->
<!--   geom_point() + -->
<!--   geom_text(colour = "black", position = "jitter") + -->
<!--   geom_line(colour = "deepskyblue3", alpha = 0.4) + -->
<!--   geom_smooth(method = "lm", se = FALSE, colour = "deepskyblue3") + -->
<!--   scale_x_date(date_labels = "%b %Y") + -->
<!--   theme_economist_white() + -->
<!--   scale_fill_economist() + -->
<!--   labs(x = "Date", -->
<!--        y = "Score", -->
<!--        colour = "Index") + -->
<!--   theme(legend.position = "right", plot.title = element_text(size=20), plot.subtitle = element_text(size = 12), text = element_text(family = "Tahoma"), plot.background = element_rect(fill = "white"), plot.margin=unit(c(0,2.5,0,0),"cm")) -->
<!--   ) -->
<!-- }) -->
<!-- ``` -->


<!-- ### Australian Karnofsky Performance Status -->

<!-- ```{r} -->

<!-- renderPlotly({ -->
<!--   req(input$actionid) -->
<!--   ggplotly(isolate(reactiveOacc4()) %>% -->
<!--   ggplot(aes(Date.of.Contact, Score, label = Spell)) + -->
<!--   geom_point() + -->
<!--   geom_text(colour = "black", position = "jitter") + -->
<!--   geom_line(alpha = 0.4, colour = "darkorange1") + -->
<!--   geom_smooth(method = "lm", se = FALSE, colour = "darkorange1") + -->
<!--   scale_x_date(date_labels = "%b %Y") + -->
<!--   theme_economist_white() + -->
<!--   scale_fill_economist() + -->
<!--   labs(x = "Date", -->
<!--        y = "Score", -->
<!--        colour = "Index") + -->
<!--   theme(legend.position = "right", plot.title = element_text(size=20), plot.subtitle = element_text(size = 12), text = element_text(family = "Tahoma"), plot.background = element_rect(fill = "white"), plot.margin=unit(c(0,2.5,0,0),"cm")) -->
<!--   ) -->
<!-- }) -->

<!-- ``` -->